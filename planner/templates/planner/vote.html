{% extends 'planner/base.html' %}

{% block content %}
<p class="lead">Voting as <strong>{{ participant.email }}</strong>.</p>

{% if invitee_link %}
  <section class="share-link" aria-label="Share invite">
    <p><strong>Share invite link with your partner</strong></p>
    <p><a href="{{ invitee_link }}">{{ invitee_link }}</a></p>
    <div class="share-actions">
      <button type="button" class="share-copy-btn" data-copy-target="{{ invitee_link }}">Copy link</button>
      {% if invite_gmail_link %}
        <a class="share-email-btn" href="{{ invite_gmail_link }}" target="_blank" rel="noopener noreferrer">Open Gmail draft</a>
      {% endif %}
    </div>
    <small class="copy-status" aria-live="polite"></small>
  </section>
{% endif %}

{% if stage == 'describe' %}
  <p class="lead">Before voting starts, share what your ideal date looks like.</p>
  <form method="post" class="stacked-form">
    {% csrf_token %}
    <input type="hidden" name="action" value="describe">
    <div class="form-row">
      <label for="{{ ideal_form.ideal_date.id_for_label }}">{{ ideal_form.ideal_date.label }}</label>
      {{ ideal_form.ideal_date }}
      {% if ideal_form.ideal_date.errors %}
        <small class="error">{{ ideal_form.ideal_date.errors|striptags }}</small>
      {% endif %}
    </div>
    <button type="submit">Save my ideal date</button>
  </form>
{% elif stage == 'waiting' %}
  <p class="lead">Your ideal date is saved. We will generate your custom questions as soon as your partner submits theirs.</p>
  <form method="post" class="stacked-form">
    {% csrf_token %}
    <input type="hidden" name="action" value="describe">
    <div class="form-row">
      <label for="{{ ideal_form.ideal_date.id_for_label }}">Update your ideal date</label>
      {{ ideal_form.ideal_date }}
      {% if ideal_form.ideal_date.errors %}
        <small class="error">{{ ideal_form.ideal_date.errors|striptags }}</small>
      {% endif %}
    </div>
    <button type="submit">Update my ideal date</button>
  </form>
{% else %}
  <form method="post" class="stacked-form">
    {% csrf_token %}
    {% for field in form %}
      <fieldset class="choice-block">
        <legend>{{ field.label }}</legend>
        {{ field }}
        {% if field.errors %}
          <small class="error">{{ field.errors|striptags }}</small>
        {% endif %}
      </fieldset>
    {% endfor %}

    <button type="submit">Save my choices</button>
  </form>
{% endif %}

<p class="alt-link"><a href="{% url 'planner:results' participant.token %}">See results status</a></p>

<script>
  (() => {
    const copyButton = document.querySelector(".share-copy-btn");
    const status = document.querySelector(".copy-status");
    if (!copyButton || !status) {
      return;
    }

    copyButton.addEventListener("click", async () => {
      const value = copyButton.dataset.copyTarget || "";
      if (!value) {
        return;
      }

      try {
        await navigator.clipboard.writeText(value);
        status.textContent = "Link copied.";
      } catch (_error) {
        status.textContent = "Copy failed. Select and copy the link above.";
      }
    });
  })();
</script>
{% endblock %}
